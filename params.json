{"name":"Yii2-ispconfig-api","tagline":"Yii2 ISPConfig API Wrapper","body":"[![Latest Stable Version](https://poser.pugx.org/mzdani/yii2-ispconfig-api/v/stable.svg)](https://packagist.org/packages/mzdani/yii2-ispconfig-api) [![Total Downloads](https://poser.pugx.org/mzdani/yii2-ispconfig-api/downloads.svg)](https://packagist.org/packages/mzdani/yii2-ispconfig-api) [![Latest Unstable Version](https://poser.pugx.org/mzdani/yii2-ispconfig-api/v/unstable.svg)](https://packagist.org/packages/mzdani/yii2-ispconfig-api) [![License](https://poser.pugx.org/mzdani/yii2-ispconfig-api/license)](https://packagist.org/packages/mzdani/yii2-ispconfig-api)\r\n\r\nInstallation\r\n------------\r\n\r\nThe preferred way to install this extension is through [composer](http://getcomposer.org/download/).\r\n\r\nEither run\r\n\r\n```\r\nphp composer.phar require --prefer-dist \"mzdani/yii2-ispconfig-api\" \"dev-master\"\r\n```\r\n\r\nor add\r\n\r\n```\r\n\"mzdani/yii2-ispconfig-api\": \"dev-master\"\r\n```\r\n\r\nto the require section of your `composer.json` file.\r\n\r\n\r\nUsage\r\n-----\r\n\r\nBelow is some example how to use the wrapper.\r\n\r\n```php\r\n<?php\r\nuse mdscomp\\ISPConfig\\SoapClient;\r\n\r\n$cp = new SoapClient('http://your.cpdomain.tld:8080/remote/index.php', 'remoteusername', 'remoteuserpass');\r\n\r\n// Get Quota Status from Client\r\n$client_records = $cp->clientGetQuota('yourclientusername');\r\n\r\nprint_r($client_records);\r\n\r\n$cp->logout();\r\n\r\n?>\r\n```\r\n\r\nDon't forget to `logoout()` after using, or your ISPConfig database remote session will full of \"open session\". And sometimes I get the wrong result because not `logout()` after get data.\r\n\r\nISPConfig Custom Patch\r\n-----\r\n\r\nBecause ISPConfig doesn't have any support to show quota usage with remote api. I must add new function into default ISPConfig remote api file. You can find it from `/usr/local/ispconfig/interface/lib/classes/remoting.inc.php`, open it and insert new function below into at the end of class.\r\n\r\n\r\n```php\r\n<?php\r\n\r\n\t/*******************\r\n\t* CUSTOM PATCH START\r\n\t*******************/\r\n\r\n\tpublic function client_get_quota($session_id, $client_username){\r\n\t\tglobal $app;\r\n\r\n\t\t/*\r\n\t\t* Get Client Data\r\n\t\t*/\r\n\t\t$client_records = $this->client_get_by_username($session_id, $client_username);\r\n\t\t$client_data = $this->client_get($session_id, $client_records['client_id']);\r\n\r\n\t\t/*\r\n\t\t* Website Harddisk Quota\r\n\t\t*/\r\n\t\t$tmp_site =  $app->db->queryAllRecords(\"SELECT data from monitor_data WHERE type = 'harddisk_quota' ORDER BY created DESC\");\r\n\t\t$monitor_data_site = array();\r\n\t\tif(is_array($tmp_site)) {\r\n\t\t\tforeach ($tmp_site as $tmp_mon_site) {\r\n\t\t\t\t$monitor_data_site = array_merge_recursive($monitor_data_site, unserialize($app->db->unquote($tmp_mon_site['data'])));\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$sites = $app->db->queryAllRecords(\"SELECT * FROM web_domain WHERE active = 'y' AND type = 'vhost' AND sys_groupid = \".$client_records['default_group']);\r\n\t\t$has_quota = false;\r\n\t\t$total_quota['limit_web_quota'] = ($client_data['limit_web_quota'] == '-1') ? $app->lng('unlimited') : $client_data['limit_web_quota']*1048576;\r\n\t\t$total_quota['limit_traffic_quota'] = ($client_data['limit_traffic_quota'] == '-1') ? $app->lng('unlimited') : $client_data['limit_traffic_quota']*1048576;\r\n\t\t$total_quota['limit_mailquota'] = ($client_data['limit_mailquota'] == '-1') ? $app->lng('unlimited') : $client_data['limit_mailquota']*1048576;\r\n\t\t$web_quota = [];\r\n\t\tif(is_array($sites) && !empty($sites)){\r\n\t\t\tfor($i=0;$i<sizeof($sites);$i++){\r\n\t\t\t\t$username = $sites[$i]['system_user'];\r\n\t\t\t\t$web_quota[$i]['domain'] = $sites[$i]['domain'];\r\n\t\t\t\t$web_quota[$i]['hd_quota'] = ($sites[$i]['hd_quota'] == '-1') ? $app->lng('unlimited') : $sites[$i]['hd_quota']*1048576;\r\n\t\t\t\t$web_quota[$i]['traffic_quota'] = ($sites[$i]['traffic_quota'] == '-1') ? $app->lng('unlimited') : $sites[$i]['traffic_quota']*1048576;\r\n\t\t\t\t$web_quota[$i]['used'] = $monitor_data_site['user'][$username]['used']*1024;\r\n\t\t\t\t$web_quota[$i]['soft'] = $monitor_data_site['user'][$username]['soft']*1024;\r\n\t\t\t\t$web_quota[$i]['hard'] = $monitor_data_site['user'][$username]['hard']*1024;\r\n\t\t\t\t$web_quota[$i]['files'] = $monitor_data_site['user'][$username]['files'];\r\n\r\n\t\t\t\tif (!is_numeric($web_quota[$i]['used'])){\r\n\t\t\t\t\tif ($web_quota[$i]['used'][0] > $web_quota[$i]['used'][1]){\r\n\t\t\t\t\t\t$web_quota[$i]['used'] = $web_quota[$i]['used'][0];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t$web_quota[$i]['used'] = $web_quota[$i]['used'][1];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (!is_numeric($web_quota[$i]['soft'])) $web_quota[$i]['soft']=$web_quota[$i]['soft'][1];\r\n\t\t\t\tif (!is_numeric($web_quota[$i]['hard'])) $web_quota[$i]['hard']=$web_quota[$i]['hard'][1];\r\n\t\t\t\tif (!is_numeric($web_quota[$i]['files'])) $web_quota[$i]['files']=$web_quota[$i]['files'][1];\t\t\t\r\n\r\n\t\t\t\tif($web_quota[$i]['soft'] == 0) $web_quota[$i]['soft'] = $app->lng('unlimited');\r\n\t\t\t\tif($web_quota[$i]['hard'] == 0) $web_quota[$i]['hard'] = $app->lng('unlimited');\r\n\r\n\t\t\t\tif($web_quota[$i]['soft'] == 0 || $web_quota[$i]['soft'] == '0') $web_quota[$i]['soft'] = $app->lng('unlimited');\r\n\t\t\t\tif($web_quota[$i]['hard'] == 0 || $web_quota[$i]['hard'] == '0') $web_quota[$i]['hard'] = $app->lng('unlimited');\r\n\r\n\t\t\t\t/*\r\n\t\t\t\t* Website Traffic Statistic\r\n\t\t\t\t*/\r\n\r\n\t\t\t\t//** Traffic of the current month\r\n\t\t\t\t$tmp_year = date('Y');\r\n\t\t\t\t$tmp_month = date('m');\r\n\t\t\t\t$tmp_rec = $app->db->queryOneRecord(\"SELECT SUM(traffic_bytes) as t FROM web_traffic WHERE hostname = '\".$app->db->quote($sites[$i]['domain']).\"' AND YEAR(traffic_date) = '$tmp_year' AND MONTH(traffic_date) = '$tmp_month'\");\r\n\t\t\t\t$web_quota[$i]['traffic']['this_month'] = number_format($tmp_rec['t'], 0, '.', '');\r\n\r\n\t\t\t\t//** Traffic of the last month\r\n\t\t\t\t$tmp_year = date('Y', mktime(0, 0, 0, date(\"m\")-1, date(\"d\"), date(\"Y\")));\r\n\t\t\t\t$tmp_month = date('m', mktime(0, 0, 0, date(\"m\")-1, date(\"d\"), date(\"Y\")));\r\n\t\t\t\t$tmp_rec = $app->db->queryOneRecord(\"SELECT sum(traffic_bytes) as t FROM web_traffic WHERE hostname = '\".$app->db->quote($sites[$i]['domain']).\"' AND YEAR(traffic_date) = '$tmp_year' AND MONTH(traffic_date) = '$tmp_month'\");\r\n\t\t\t\t$web_quota[$i]['traffic']['last_month'] = number_format($tmp_rec['t']*1024, 0, '.', '');\r\n\t\t\t}\r\n\t\t\t$has_quota = true;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\t* Email Quota\r\n\t\t*/\r\n\t\t$tmp_mails =  $app->db->queryAllRecords(\"SELECT data from monitor_data WHERE type = 'email_quota' ORDER BY created DESC\");\r\n\t\t$monitor_data_mails = array();\r\n\t\tif(is_array($tmp_mails)) {\r\n\t\t\tforeach ($tmp_mails as $tmp_mon_mails) {\r\n\t\t\t\t$tmp_array = unserialize($app->db->unquote($tmp_mon_mails['data']));\r\n\t\t\t\tif(is_array($tmp_array)) {\r\n\t\t\t\t\tforeach($tmp_array as $username => $data) {\r\n\t\t\t\t\t\tif(!$monitor_data_mails[$username]['used']) $monitor_data_mails[$username]['used'] = $data['used'];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$emails = $app->db->queryAllRecords(\"SELECT * FROM mail_user WHERE 1 AND sys_groupid = \".$client_records['default_group']);\r\n\t\t$has_mailquota = false;\r\n\t\t$mails_quota = [];\r\n\t\tif(is_array($emails) && !empty($emails)){\r\n\t\t\tfor($i=0;$i<sizeof($emails);$i++){\r\n\t\t\t\t$email = $emails[$i]['email'];\r\n\r\n\t\t\t\t$mails_quota[$i]['email'] = $emails[$i]['email'];\r\n\t\t\t\t$mails_quota[$i]['used'] = isset($monitor_data_mails[$email]['used']) ? $monitor_data_mails[$email]['used'] : array(1 => 0);\r\n\r\n\t\t\t\tif (!is_numeric($mails_quota[$i]['used'])) $mails_quota[$i]['used']=$mails_quota[$i]['used'][1];\r\n\r\n\t\t\t\tif($mails_quota[$i]['quota'] == 0){\r\n\t\t\t\t\t$mails_quota[$i]['quota'] = $app->lng('unlimited');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t$has_mailquota = true;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\t* Returning Data\r\n\t\t*/\r\n\t\t$return = [\r\n\t\t\t'limit' => $total_quota,\r\n\t\t\t'used' => [\r\n\t\t\t\t'site' => ($has_quota) ? $web_quota : false,\r\n\t\t\t\t'mail' => ($has_mailquota) ? $mails_quota : false,\r\n\t\t\t],\r\n\t\t];\r\n\t\treturn $return;\r\n\t}\r\n\r\n\t/*****************\r\n\t* CUSTOM PATCH END\r\n\t*****************/\r\n\r\n?>\r\n```\r\n\r\nAfter adding those function. Here is some example using the new function.\r\n\r\n```php\r\n<?php\r\n\r\n/**\r\n * Get Status ISPConfig Panel\r\n */\r\nuse mdscomp\\ISPConfig\\SoapClient;\r\n\r\n$cp                                  = new SoapClient('http://your.cpdomain.tld:8080/remote/index.php', 'remoteusername', 'remoteuserpasswd');\r\n$data                                = $cp->clientGetQuota('clientusername');\r\n\r\n$max_quota_hdd     = $data['limit']['limit_web_quota'];\r\n$max_quota_traffic = $data['limit']['limit_traffic_quota'];\r\n$max_quota_mail    = $data['limit']['limit_mailquota'];\r\n\r\n$used_quota_hdd = 0;\r\n$used_quota_traffic = 0;\r\nforeach ($data['used']['site'] as $key => $value) {\r\n\t$used_quota_hdd += $value['used'];\r\n\t$used_quota_traffic += $value['traffic']['this_month'];\r\n}\r\nYii::$app->formatter->sizeFormatBase = 1000;\r\n$tpl[] = [\r\n\t'item'    => 'Disk Space Usage',\r\n\t'used'    => Yii::$app->formatter->asShortSize($used_quota_hdd, 2),\r\n\t'max'     => ($max_quota_hdd !== 'unlimited') ? Yii::$app->formatter->asShortSize($max_quota_hdd, 2) : $max_quota_hdd,\r\n\t'percent' => ($max_quota_hdd !== 'unlimited') ? round((($used_quota_hdd/$max_quota_hdd) * 100), 2) : 0,\r\n];\r\n\r\nYii::$app->formatter->sizeFormatBase = 1024;\r\n$tpl[] = [\r\n\t'item'    => 'Traffic Usage',\r\n\t'used'    => Yii::$app->formatter->asShortSize($used_quota_traffic, 2),\r\n\t'max'     => ($max_quota_traffic !== 'unlimited') ? Yii::$app->formatter->asShortSize($max_quota_traffic, 2) : $max_quota_traffic,\r\n\t'percent' => ($max_quota_traffic !== 'unlimited') ? round((($used_quota_traffic/$max_quota_traffic) * 100), 2) : 0,\r\n];\r\n\r\nYii::$app->formatter->sizeFormatBase = 1000;\r\n$used_quota_mail = 0;\r\nif (isset($data['used']['mail']) && is_array($data['used']['mail'])) {\r\n\tforeach ($data['used']['mail'] as $key => $value) {\r\n\t\t$used_quota_mail += $value['used'];\r\n\t}\r\n\t$tpl[] = [\r\n\t\t'item'    => 'Email Space Usage',\r\n\t\t'used'    => Yii::$app->formatter->asShortSize($used_quota_mail, 2),\r\n\t\t'max'     => ($max_quota_hdd !== 'unlimited') ? Yii::$app->formatter->asShortSize($max_quota_mail, 2) : $max_quota_mail,\r\n\t\t'percent' => ($max_quota_hdd !== 'unlimited') ? round((($used_quota_mail/$max_quota_mail) * 100), 2) : 0,\r\n\t];\r\n}\r\n\r\n$cp->logout();\r\n\r\n?>\r\n```\r\n\r\nand after some theming, here is the result.\r\n\r\n![Screenshot_507.jpg](https://bitbucket.org/repo/76XnzK/images/2480093029-Screenshot_507.jpg)\r\n![Screenshot_508.jpg](https://bitbucket.org/repo/76XnzK/images/884887269-Screenshot_508.jpg)\r\n![Screenshot_509.jpg](https://bitbucket.org/repo/76XnzK/images/1760568156-Screenshot_509.jpg)\r\n![Screenshot_510.jpg](https://bitbucket.org/repo/76XnzK/images/2286964774-Screenshot_510.jpg)\r\n\r\nSorry for my bad english and code. Have fun!","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}